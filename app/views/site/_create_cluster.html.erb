<div class="modal fade" id="clusterModal" tabindex="-1" role="dialog" aria-labelledby="clusterModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="clusterModallabel">Create Cluster</h2>
      </div>
      <div class="modal-body row">
        <div class="col-md-1"></div>
        <form class="form form-group col-md-10" id="create-cluster-form">
          <label for="name">Name</label>
          <input class="form-control" type="text" placeholder="Lower Case Letters Only" name="name" id="name"/>
          <p>
            <a data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
              <span class="fa-caret-right fa fa-fw"></span>Optional Settings
            </a>
          </p>
          <div class="collapse" id="collapseExample">
            <div class="card card-body">
              <div class="row">
                <div class="col-md-6">
                  <label for="masterMachineType">Master Machine Type</label>
                  <select name="masterMachineType" id="masterMachineType" class="form-control">
                    <option value="n1-standard-1">n1-standard-1</option>
                    <option value="n1-standard-2">n1-standard-2</option>
                    <option value="n1-standard-4" selected="">n1-standard-4</option>
                    <option value="n1-standard-8">n1-standard-8</option>
                    <option value="n1-standard-16">n1-standard-16</option>
                    <option value="n1-standard-32">n1-standard-32</option>
                    <option value="n1-standard-64">n1-standard-64</option>
                    <option value="n1-standard-96">n1-standard-96</option>
                    <option value="n1-highcpu-4">n1-highcpu-4</option>
                    <option value="n1-highcpu-8">n1-highcpu-8</option>
                    <option value="n1-highcpu-16">n1-highcpu-16</option>
                    <option value="n1-highcpu-32">n1-highcpu-32</option>
                    <option value="n1-highcpu-64">n1-highcpu-64</option>
                    <option value="n1-highcpu-96">n1-highcpu-96</option>
                    <option value="n1-highmem-2">n1-highmem-2</option>
                    <option value="n1-highmem-4">n1-highmem-4</option>
                    <option value="n1-highmem-8">n1-highmem-8</option>
                    <option value="n1-highmem-16">n1-highmem-16</option>
                    <option value="n1-highmem-32">n1-highmem-32</option>
                    <option value="n1-highmem-64">n1-highmem-64</option>
                    <option value="n1-highmem-96">n1-highmem-96</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="masterDiskSize">Master Disk Size (GB)</label>
                  <input class="form-control" type="number" value="500" name="masterDiskSize" id ="masterDiskSize"/>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <label for="numberOfWorkers">Workers</label>
                  <input class="form-control" type="number" value="0" name="numberOfWorkers" id="numberOfWorkers"/>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label for="numberOfWorkerLocalSSDs">Worker Local SSDs</label>
                  <input class="form-control" type="number" value="0" name="numberOfWorkerLocalSSDs" id ="numberOfWorkerLocalSSDs"/>
                </div>
                <div class="col-md-6">
                  <label for="numberOfPreemptibleWorkers">Preemptible Workers</label>
                  <input class="form-control" type="number" value="0" name="numberOfPreemptibleWorkers" id ="numberOfPreemptibleWorkers"/>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label for="workerMachineType">Worker Machine Type</label>
                  <select name="workerMachineType" id="workerMachineType" class="form-control">
                    <option value="n1-standard-1">n1-standard-1</option>
                    <option value="n1-standard-2">n1-standard-2</option>
                    <option value="n1-standard-4" selected="">n1-standard-4</option>
                    <option value="n1-standard-8">n1-standard-8</option>
                    <option value="n1-standard-16">n1-standard-16</option>
                    <option value="n1-standard-32">n1-standard-32</option>
                    <option value="n1-standard-64">n1-standard-64</option>
                    <option value="n1-standard-96">n1-standard-96</option>
                    <option value="n1-highcpu-4">n1-highcpu-4</option>
                    <option value="n1-highcpu-8">n1-highcpu-8</option>
                    <option value="n1-highcpu-16">n1-highcpu-16</option>
                    <option value="n1-highcpu-32">n1-highcpu-32</option>
                    <option value="n1-highcpu-64">n1-highcpu-64</option>
                    <option value="n1-highcpu-96">n1-highcpu-96</option>
                    <option value="n1-highmem-2">n1-highmem-2</option>
                    <option value="n1-highmem-4">n1-highmem-4</option>
                    <option value="n1-highmem-8">n1-highmem-8</option>
                    <option value="n1-highmem-16">n1-highmem-16</option>
                    <option value="n1-highmem-32">n1-highmem-32</option>
                    <option value="n1-highmem-64">n1-highmem-64</option>
                    <option value="n1-highmem-96">n1-highmem-96</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="workerDiskSize">Worker Disk Size (GB)</label>
                  <input class="form-control" type="number" value="500" name="workerDiskSize" id ="workerDiskSize"/>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <label for="extensionUri">Extension Uri</label>
                  <input class="form-control" type="text" name="extensionUri" id="extensionUri"/>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <label for="customScriptUri">Custom Script Uri</label>
                  <input class="form-control" type="text" name="customScriptUri" id="customScriptUri"/>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div class="col-md-1"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-dismiss="modal">Cancel</button>
        <button type="button" id="create-cluster-button" class="btn btn-primary">Create</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" nonce="<%= content_security_policy_script_nonce %>">
    <%= render partial: 'notebooks_api_functions.js.erb'%>
</script>

<script type="text/javascript" nonce="<%= content_security_policy_script_nonce %>">
    <% if user_signed_in? %>
        // headers and api parametrs
        var workspace = "<%= @study.firecloud_project %>";
        var access_token = "Bearer <%= current_user.access_token['access_token']%>";

        // api headers
        var headers = {
            "Authorization": access_token,
            "Content-Type": "application/json"
        };

        // bind create button to form submit
        $('#create-cluster-button').click(function () {
            $('#create-cluster-form').submit();
        });

        $('#create-cluster-form').submit(function (event) {
            // stop submit to nothing
            event.preventDefault();
            // get form inputs
            var createParams = $(this).serializeArray().reduce((map, obj) => (map[obj.name] = obj.value, map), {});
            // format payload for api call
            var parsedCreateParams = {
                "labels": {},
                "machineConfig": {
                    "numberOfWorkers": parseInt(createParams.numberOfWorkers),
                    "masterMachineType": createParams.masterMachineType,
                    "masterDiskSize": parseInt(createParams.masterDiskSize),
                    "workerMachineType": createParams.workerMachineType,
                    "workerDiskSize": parseInt(createParams.workerDiskSize),
                    "numberOfWorkerLocalSSDs": parseInt(createParams.numberOfWorkerLocalSSDs),
                    "numberOfPreemptibleWorkers": parseInt(createParams.numberOfPreemptibleWorkers)
                }
            };
            // need the cluster name for api call
            var clusterName = createParams.name;
            // createCluster api call
            var create = createCluster(workspace, clusterName, headers, parsedCreateParams);
            // if call was successful close the modal
            if (create.status === 200) {
                $('#clusterModal').modal('toggle');
            }

            refreshTable()

        });
    <% end %>
</script>