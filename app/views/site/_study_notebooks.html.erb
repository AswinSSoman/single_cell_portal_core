<%= render "create_cluster.html.erb"%>
<div class="row">
  <div class="col-md-12">
    <div>
      <h2 id="spark-clusters-title">Spark Clusters</h2>
    </div>

    <table id="spark-clusters-table" class="table table-striped table-condensed">
      <div class="row form-group">
        <div class="col-xs-7">
          <span>
            Launch an interactive analysis environment based on Jupyter notebooks, Spark, and Hail. This beta feature is under active development. See documentation <a href="https://software.broadinstitute.org/firecloud/documentation/quickstart?page=notebooks" target="_blank">here<span class="fa-external-link fa "></span></a>
          </span>
        </div>
        <div class="col-xs-3">
        </div>
        <div class="col-xs-2">
          <a id="create-modal-button" state="enabled" class="pull-right button btn btn-md btn-primary" href="javascript:;" data-toggle="modal" data-target="#clusterModal"><span>Create Cluster</span></a>
        </div>
      </div>
      <div class="row" id="no_clusters_well">
        <div class="col-lg-12">
          <div id="message-well" class="well">
            <h4 class="text-center">There are no clusters to display.</h4>
          </div>
        </div>
      </div>
    </table>
  </div>
</div>
<span></span>
<button id="activate_datatable">Switch to datatable</button>

<script type="text/javascript" nonce="<%= content_security_policy_script_nonce %>">
    <%= render partial: 'notebooks_api_functions.js.erb'%>
</script>

<script type="text/javascript" nonce="<%= content_security_policy_script_nonce %>">
    <% if user_signed_in? %>
      var workspace =  "<%= @study.firecloud_project %>";

      var access_token = "Bearer <%= current_user.access_token['access_token']%>";

      console.log(access_token);
      // render api scripts
      var headers = {"Authorization": access_token};
          //var p = ping(headers);
      //console.log(p.responseText);
      var clusterList = listClusters(workspace, headers);
      var clusterArr = JSON.parse(clusterList.response);

      var tableArr = [];
      for(var i = 0; i < clusterArr.length; i++){
          var clusterResponse = clusterArr[i];
          var status = clusterResponse.status ? clusterResponse.status : "";
          var createdDate = clusterResponse.createdDate ? clusterResponse.createdDate : "";
          var masterMachineType = clusterResponse.machineConfig.masterMachineType ? clusterResponse.machineConfig.masterMachineType : "";
          var masterDiskSize = clusterResponse.machineConfig.masterDiskSize ? clusterResponse.machineConfig.masterDiskSize : "";
          var clusterName = clusterResponse.clusterName ? clusterResponse.clusterName : "";
          var numberOfWorkers = clusterResponse.machineConfig.numberOfWorkers ? clusterResponse.machineConfig.numberOfWorkers : "";
          var workerMachineType = clusterResponse.machineConfig.workerMachineType ? clusterResponse.machineConfig.workerMachineType : "";
          var workerDiskSize = clusterResponse.machineConfig.workerDiskSize ? clusterResponse.machineConfig.workerDiskSize : "";
          var numberOfWorkerLocalSSDs = clusterResponse.machineConfig.numberOfWorkerLocalSSDs ? clusterResponse.machineConfig.numberOfWorkerLocalSSDs : "";
          var numberOfPreemptibleWorkers = clusterResponse.machineConfig.numberOfPreemptibleWorkers ? clusterResponse.machineConfig.numberOfPreemptibleWorkers : "";
          var creator = clusterResponse.labels.creator ?  clusterResponse.labels.creator : "";

          tableArr.push([status, createdDate, masterMachineType, masterDiskSize, clusterName, numberOfWorkers, workerMachineType, workerDiskSize, numberOfWorkerLocalSSDs, numberOfPreemptibleWorkers, creator])
      }
      console.log(clusterArr);
    <% end %>

    $('#activate_datatable').click(function () {
        $('#spark-clusters-table').DataTable( {
            data: tableArr,
            columns: [
                { title: "Status" },
                { title: "Create Date" },
                { title: "master Machine Type" },
                { title: "Master Disk Size (GB)" },
                { title: "Name" },
                { title: "Workers" },
                { title: "Worker Machine Type" },
                { title: "Worker Disk Size (GB)" },
                { title: "Worker Local SSDs" },
                { title: "Preemptible Workers" },
                { title: "Creator Email"}
            ],
            autoWidth: false,
            paging: true,
            buttons: [{ extend: 'columnsToggle', className: 'btn btn-large btn-primary' }, {extend: 'filter', className: 'excelButton' }]
        } );
        $('#no_clusters_well').hide()
    });
</script>
