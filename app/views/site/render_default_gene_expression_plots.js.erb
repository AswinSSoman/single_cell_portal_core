var exp_target_<%= @identifier %> = '<%= @target %>'
$('#' + exp_target_<%= @identifier %>).empty();
$('#<%= @target %>-options').html("<%= escape_javascript(render partial: '/site/search/gene_result_view_options') %>");
var expressionData_<%= @identifier %> = [];
<% if @values_box_type == 'box' %>
    <% @values.sort_by {|k,v| k}.each_with_index do |(cluster, data), index| %>
      var cluster_<%= index %>_exp = {
        y: <%= raw data[:y] %>,
        name: "<%= data[:name] %>",
        <% if params[:boxpoints].nil? %>
            boxpoints: 'all',
        <% elsif params[:boxpoints].blank? %>
            boxpoints: false,
        <% else %>
            boxpoints: "<%= params[:boxpoints] %>",
        <% end %>
        boxmean: true,
        type: 'box',
        marker: {
          color: colorBrewerSet[<%= index %> % 27],
          line: {
            color: plotlyDefaultLineColor,
            width: <%= @study.show_cluster_point_borders? ? 0.5 : 0 %>
          }
        }
      };

      expressionData_<%= @identifier %>.push(cluster_<%= index %>_exp);
    <% end %>

    var expressionLayout_<%= @identifier %> = {
        hovermode: 'closest',
        yaxis: {
            title: '<%= @y_axis_title %>',
        },
        font: plotlyLabelFont
    };
<% else %>
    //Using jitter_var instead of jitter because selector is called jitter, avoid confusion
    var jitter_var_<%= @identifier %> = "<%= @values_jitter %>";
    var formatted_array_<%= @identifier %> = [];
    <% @values.sort_by {|k,v| k}.each do |cluster, data| %>
      formatted_array_<%= @identifier %>.push(["<%= cluster %>", <%= raw data[:y] %>]);
    <% end %>
    var title_<%= @identifier %>= "<%= params[:cluster]%>";
    var data_<%= @identifier %> = createTracesAndLayout(formatted_array_<%= @identifier %>, title_<%= @identifier %>, jitter_var_<%= @identifier %>);
    expressionData_<%= @identifier %> = [].concat.apply([], data_<%= @identifier %>[0] );
    expressionLayout_<%= @identifier %> = data_<%= @identifier %>[1];
<% end%>

Plotly.newPlot(exp_target_<%= @identifier %>, expressionData_<%= @identifier %>, expressionLayout_<%= @identifier %>);

function renderDistribution<%= @identifier %>() {
    var target1 = document.getElementById('study-<%= @study.url_safe_name %>-gene-<%= params[:gene] %>');
    // no need to store spinners in data attribute as entire plot div will be re-rendered
    new Spinner(opts).spin(target1);

    var url = '<%= render_default_gene_expression_plots_path(study_name: @study.url_safe_name, gene: params[:gene]) %>?';
    var cluster = $('#<%= @target %>-cluster').val();
    var annotation = $('#<%= @target %>-annotation').val();
    var subsample = $('#<%= @target %>-subsample').val();
    var identifier = '<%= @identifier %>'
    url += 'cluster=' + cluster + '&annotation=' + annotation + '&subsample=' + subsample + '&identifier=' + identifier;
    // append request token to validate XHR requests
    var requestToken = '<%= params[:request_user_token] %>'
    url += '&request_user_token=' + requestToken;

    // make call to load distribution plot
    $.ajax({
        url: url,
        method: 'GET',
        dataType: 'script'
    });
}

// listener for cluster nav, specific to study page
$("#<%= @target %>-annotation, #<%= @target %>-subsample").change(function() {
    renderDistribution<%= @identifier %>()
});

$("#<%= @target %>-cluster").change(function() {
    $('#cluster-plot').data('rendered', false);
    var newCluster = $(this).val();
    var currAnnot = $('#<%= @target %>-annotation').val();
    // get new annotation options and re-render
    $.ajax({
        url: "<%= get_new_annotations_path(study_name: @study.url_safe_name)%>?cluster=" + newCluster + '&target=<%= @target %>',
        method: 'GET',
        dataType: 'script',
        success: function (data) {
            // parse response as a string and see if currently selected annotation exists in new annotations
            if (data.indexOf(currAnnot) >= 0) {
                $('#<%= @target %>-annotation').val(currAnnot);
            }
            $(document).ready(function () {
                // since we now have new annotations, we need to set them in the search form for persistence
                var an = $('#annotation').val();
                renderDistribution<%= @identifier %>()
            });
        }
    });
});